<!DOCTYPE html>
let chart;


function setStatus(online, ts) {
els.statusDot.className = 'inline-block w-3 h-3 rounded-full ' + (online ? 'bg-green-500' : 'bg-red-500');
els.lastUpdate.textContent = ts ? new Date(ts).toLocaleString() : '-';
}


async function fetchStatus() {
const r = await fetch(`${BACKEND}/status`);
const json = await r.json();
setStatus(json.online, json.lastUpdate);
}


async function fetchLatest() {
const r = await fetch(`${BACKEND}/data/latest`);
const json = await r.json();
els.latestCount.textContent = json?.count ?? '-';
els.latestDistance.textContent = json?.distance ?? '-';
}


async function fetchThreshold() {
const r = await fetch(`${BACKEND}/threshold`);
const text = await r.text();
els.thresholdCurrent.textContent = text;
}


async function fetchHistory() {
const r = await fetch(`${BACKEND}/data/history?limit=100`);
const data = await r.json();
const labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
const counts = data.map(d => d.count);
const distances = data.map(d => d.distance);


if (!chart) {
const ctx = document.getElementById('historyChart').getContext('2d');
chart = new Chart(ctx, {
type: 'line',
data: {
labels,
datasets: [
{ label: 'Count', data: counts },
{ label: 'Distance (cm)', data: distances }
]
},
options: {
responsive: true,
maintainAspectRatio: false,
scales: { x: { display: true }, y: { beginAtZero: true } }
}
});
} else {
chart.data.labels = labels;
chart.data.datasets[0].data = counts;
chart.data.datasets[1].data = distances;
chart.update();
}
}


els.saveThreshold.addEventListener('click', async () => {
const val = Number(els.thresholdInput.value);
if (Number.isNaN(val)) return alert('Enter a valid number');
await fetch(`${BACKEND}/threshold`, {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({ threshold: val })
});
els.thresholdInput.value = '';
fetchThreshold();
});


async function refreshAll() {
await Promise.all([
fetchStatus(),
fetchLatest(),
fetchThreshold(),
fetchHistory(),
]);
}


refreshAll();
setInterval(refreshAll, 5000);
</script>
</body>
</html>
