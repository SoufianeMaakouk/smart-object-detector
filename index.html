<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Object Monitor</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: sans-serif; margin:20px; }
  .status { display:flex; align-items:center; gap:10px; }
  .status-dot { width:12px; height:12px; border-radius:50%; display:inline-block; }
  .dashboard { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
  .card { padding:10px; border:1px solid #ccc; border-radius:8px; }
  #historyChart { width:100%; height:300px; }
  .flash { background-color: #a0f0a0; transition: background 0.5s; }
</style>
</head>
<body>

<h1>Smart Object Monitor</h1>

<div class="dashboard">
  <div class="card">
    <h3>Status</h3>
    <div class="status">
      <div id="statusDot" class="status-dot bg-red-500"></div>
      <span>Last update: <span id="lastUpdate">-</span></span>
    </div>
    <h3>Latest Count: <span id="latestCount">-</span></h3>
    <button id="resetCounter">Reset Counter</button>
  </div>

  <div class="card">
    <h3>Threshold</h3>
    Current: <span id="thresholdCurrent">-</span> cm<br>
    <input id="thresholdInput" type="number" placeholder="New threshold">
    <button id="saveThreshold">Save</button>
  </div>
</div>

<div class="card">
  <h3>History (Last 100)</h3>
  <canvas id="historyChart"></canvas>
</div>

<script>
const BACKEND = "https://smart-object-monitor-backend.onrender.com";

const els = {
  statusDot: document.getElementById('statusDot'),
  lastUpdate: document.getElementById('lastUpdate'),
  latestCount: document.getElementById('latestCount'),
  resetCounter: document.getElementById('resetCounter'),
  thresholdCurrent: document.getElementById('thresholdCurrent'),
  thresholdInput: document.getElementById('thresholdInput'),
  saveThreshold: document.getElementById('saveThreshold'),
};

let chart;
let lastCount = 0;

function setStatus(online, ts) {
  els.statusDot.style.backgroundColor = online ? 'green' : 'red';
  els.lastUpdate.textContent = ts ? new Date(ts).toLocaleString() : '-';
}

async function fetchStatus() {
  try {
    const r = await fetch(`${BACKEND}/status`);
    const json = await r.json();
    setStatus(json.online, json.lastUpdate);
  } catch(e){ console.error(e); }
}

async function fetchLatest() {
  try {
    const r = await fetch(`${BACKEND}/data/latest`);
    const json = await r.json();
    const newCount = json?.count ?? 0;
    els.latestCount.textContent = newCount;

    // Flash if new object or reset
    if(newCount !== lastCount) {
      els.latestCount.classList.add('flash');
      setTimeout(()=>els.latestCount.classList.remove('flash'), 500);
    }
    lastCount = newCount;
  } catch(e){ console.error(e); }
}

async function fetchThreshold() {
  try {
    const r = await fetch(`${BACKEND}/threshold`);
    els.thresholdCurrent.textContent = await r.text();
  } catch(e){ console.error(e); }
}

async function fetchHistory() {
  try {
    const r = await fetch(`${BACKEND}/data/history?limit=100`);
    const data = await r.json();
    const labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
    const counts = data.map(d => d.count);

    if (!chart) {
      const ctx = document.getElementById('historyChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label:'Count',
            data:counts,
            borderColor:'blue',
            backgroundColor:'rgba(0,0,255,0.1)',
            pointBackgroundColor: counts.map((_,i)=>i===counts.length-1?'green':'blue')
          }]
        },
        options: { responsive:true, maintainAspectRatio:false }
      });
    } else {
      chart.data.labels = labels;
      chart.data.datasets[0].data = counts;
      chart.data.datasets[0].pointBackgroundColor = counts.map((_,i)=>i===counts.length-1?'green':'blue');
      chart.update();
    }
  } catch(e){ console.error(e); }
}

// Save new threshold
els.saveThreshold.addEventListener('click', async () => {
  const val = Number(els.thresholdInput.value);
  if (Number.isNaN(val)) return alert('Enter a valid number');
  try {
    await fetch(`${BACKEND}/threshold`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({threshold: val}) });
    els.thresholdInput.value = '';
    fetchThreshold();
  } catch(e){ console.error(e); }
});

// Reset counter
els.resetCounter.addEventListener('click', async () => {
  if(!confirm("Reset counter?")) return;
  try {
    const r = await fetch(`${BACKEND}/reset`, { method:'POST' });
    const json = await r.json();
    if(json.success){ lastCount = 0; fetchLatest(); fetchHistory(); }
  } catch(e){ console.error(e); }
});

// Refresh all data
async function refreshAll() {
  await Promise.all([fetchStatus(), fetchLatest(), fetchThreshold(), fetchHistory()]);
}

document.addEventListener("DOMContentLoaded", ()=> {
  refreshAll();
  setInterval(refreshAll, 5000);
});
</script>
</body>
</html>
